!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["Lambda Webpack Plugin"]=t():e["Lambda Webpack Plugin"]=t()}(global,(function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=4)}([function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("make-dir")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SamWebpackPlugin=void 0;var n=i(o(0)),r=i(o(1)),s=o(5);function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function c(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){u(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function u(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}const l="SamWebpackPlugin",d=e=>Object.keys(e).sort().reduce((t,o)=>("object"!=typeof e[o]||Array.isArray(e[o])?t[o]=e[o]:t[o]=d(e[o]),t),{});t.SamWebpackPlugin=class{constructor(e){if(u(this,"declarationRegex",/(?<=@WebpackLambda\()([^\)]+)(?=(\)))/g),u(this,"deploymentFolder",void 0),u(this,"options",{}),u(this,"layers",{}),u(this,"baseTemplate",void 0),u(this,"packageLock",void 0),e.output&&"string"!=typeof e.output)throw`[${l}]: options.output must be of type String`;if(this.deploymentFolder=e.output||"./lambda-sam-deploy",e.verbose&&"boolean"!=typeof e.verbose)throw`[${l}]: options.output must be a boolean`;if(this.options.verbose=e.verbose||!1,e.requireTxt&&"boolean"!=typeof e.requireTxt)throw`[${l}]: options.requireTxt must be a boolean`;if(this.options.requireTxt=e.requireTxt||!1,Boolean(e.layers)&&"object"!=typeof e.layers)throw`[${l}]: options.layers must be of type object`;if(this.layers=e.layers,e.dynamoDb&&"string"!=typeof e.dynamoDb)throw`[${l}]: options.dynamoDb of type String`;if(this.options.dynamoDb=e.dynamoDb,!e.baseTemplate||"string"!=typeof e.baseTemplate)throw`[${l}]: options.baseTemplate must be of defined and of type String`;try{this.baseTemplate=JSON.parse(n.default.readFileSync(e.baseTemplate,"utf8"))}catch(e){throw`[${l}]: Error loading/parsing baseTemplate`}this.packageLock=JSON.parse(n.default.readFileSync("./package-lock.json","utf8")),console.log(Object.keys(this.packageLock.dependencies).length)}parseLambdaDeclaration(e){const t=e.match(this.declarationRegex);if(t)return JSON.parse(t[0])}logDependencies(e){const t=[],o=[],n=e;for(;n&&Array.isArray(n)&&n.length>0;){const s=n[0];if(s.request){const e=s.request===r.default.basename(s.request),n=s.module&&s.module.externalType,i=s.module&&s.module.dependencies;if(i){const e=i.filter(e=>e.request&&!o.includes(e.request)||!e.request);t.push(...e)}e&&t.push({request:s.request,type:n}),o.push(s.request)}e.shift()}return t}getPackageDependencies(e,t){try{const t=this.packageLock&&this.packageLock.dependencies&&this.packageLock.dependencies[e];return t&&t.requires?Object.keys(t.requires):[]}catch(e){throw e}}getAllDependencies(e,t){const o=Array.isArray(e)?e:[e],n=[];for(;o.length>0;){const e=o.shift();try{const r=this.getPackageDependencies(e,t).filter(e=>!n.includes(e));o.push(...r),n.push(e)}catch(e){console.warn(`WARN: Lambda Webpack Plugin: ${e}`)}}return n}apply(e){const t={name:l},o={entries:{},outputPath:e.options.output.path,deployFolder:r.default.join(e.options.context,this.deploymentFolder),alias:e.options.resolve.alias};e.hooks.entryOption.tap(t,(e,t)=>{if("string"==typeof t)throw`[${l}]: webpack entries option must be an object not String.`;o.entries=Object.keys(t).reduce((o,s)=>{try{const i=n.default.readFileSync(t[s],"utf8"),a=this.parseLambdaDeclaration(i);return a?c({},o,{[s]:{key:s,context:e,path:t[s],files:[],filename:r.default.basename(s,r.default.extname(s)),config:a,dependencies:[]}}):o}catch(e){return console.error("error parsing entry content"),o}},{})}),e.hooks.emit.tapAsync(t,(e,t)=>{e.chunks.forEach(e=>{o.entries[e.name]&&(o.entries[e.name].files=e.files,o.entries[e.name].dependencies=this.logDependencies(e.entryModule.dependencies).reduce((e,t)=>(e.find(e=>e.request===t.request)||e.push(t),e),[]))}),t()}),e.hooks.done.tapAsync(t,(e,t)=>{console.log("Creating Lambda Package"),console.time("Create lambda Package Timer");const i=Object.keys(o.entries).map(e=>o.entries[e]),a=[];if(a.push((0,s.rimrafAction)({source:o.deployFolder},this.options)),a.push((0,s.mkdirAction)({source:o.deployFolder},this.options)),i.forEach(e=>{const t=e.filename,n=r.default.join(o.deployFolder,t);if(a.push((0,s.mkdirAction)({source:n},this.options)),e.files.forEach(e=>{a.push((0,s.copyAction)({source:r.default.join(o.outputPath,e),destination:n},this.options))}),a.push((0,s.mkdirAction)({source:r.default.join(n,"node_modules")},this.options)),this.options.requireTxt){const t=e.dependencies.map(e=>e.request).join(" \n");a.push((0,s.createAction)({source:r.default.join(n,"requirements.txt"),content:t},this.options))}if(!this.options.requireTxt){const t=[],o=[...e.dependencies],i=[];for(;o.length>0;){const n=o[0];if(this.layers&&this.layers[n.request])!t.includes(n.request)&&t.push(n.request),!i.includes(n.request)&&i.push(n.request);else if(void 0!==n.type&&null!==n.type&&"null"!==n.type&&"undefined"!==n.type){if(n.module&&n.module.buildInfo&&n.module.buildInfo.hasOwnProperty("fileDependencies")){const e=[...n.module.dependencies.filter(e=>e.module&&!i.includes(e.request))];!i.includes(n.request)&&i.push(n.request),o.push(...e)}else{const o=this.getAllDependencies(n.request,r.default.join(e.context,"node_modules"));t.push(...o.filter(e=>!t.includes(e))),!i.includes(n.request)&&i.push(n.request)}}o.shift()}console.log(t.length),t.forEach(t=>{let o=void 0;o=this.layers&&this.layers[t]?r.default.join(this.layers[t],"**/*"):r.default.join(e.context,"node_modules",t,"**/*"),a.push((0,s.copyAction)({source:o,destination:r.default.join(n,"node_modules",t)},this.options))})}const i=d({[`Function${e.filename.replace(/-/g,"")}`]:c({},e.config,{Type:"AWS::Serverless::Function",Properties:c({},e.config.Properties,{},e.config.properties,{CodeUri:`./${t}`})})});this.baseTemplate=c({},this.baseTemplate,{Resources:c({},this.baseTemplate.Resources,{},i)})}),this.options.dynamoDb){const e=JSON.parse(n.default.readFileSync(`${this.options.dynamoDb}`,"utf8"));Object.keys(e).forEach(t=>{this.baseTemplate.Resources[t]={Type:"AWS::DynamoDB::Table",Properties:e[t]}})}if(a.push((0,s.createAction)({source:r.default.join(o.deployFolder,"template.json"),content:JSON.stringify(JSON.parse(JSON.stringify(this.baseTemplate)))},this.options)),a.length){a.reduce((e,t)=>e.then(e=>t(e)).catch(e=>console.log(e)),Promise.resolve()).then(()=>{console.timeEnd("Create lambda Package Timer"),t()}).catch(e=>{console.timeEnd("Create lambda Package Timer"),console.error(e),t()})}else console.timeEnd("Create lambda Package Timer"),t()})}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"copyAction",{enumerable:!0,get:function(){return n.copyAction}}),Object.defineProperty(t,"moveAction",{enumerable:!0,get:function(){return r.moveAction}}),Object.defineProperty(t,"mkdirAction",{enumerable:!0,get:function(){return s.mkdirAction}}),Object.defineProperty(t,"archiveAction",{enumerable:!0,get:function(){return i.archiveAction}}),Object.defineProperty(t,"createAction",{enumerable:!0,get:function(){return a.createAction}}),Object.defineProperty(t,"rimrafAction",{enumerable:!0,get:function(){return c.rimrafAction}});var n=o(6),r=o(8),s=o(10),i=o(11),a=o(13),c=o(14)},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.copyAction=function(e,t){const{verbose:o}=t;if(!e.source||!e.destination)return void(o&&console.log("  - FileManagerPlugin: Warning - copy parameter has to be formated as follows: { source: <string>, destination: <string> }"));return()=>new Promise((s,c)=>{void 0===/(\*|\{+|\}+)/g.exec(e.source)?n.default.lstat(e.source,(l,d)=>{if(l)return c(l);n.default.lstat(e.destination,(n,l)=>{if(d.isFile()){const t=l&&l.isDirectory()?e.destination+"/"+r.default.basename(e.source):e.destination;o&&console.log(`  - FileManagerPlugin: Start copy source: ${e.source} to destination: ${t}`);const n=r.default.parse(t),u=(e,t)=>{i.default.copy(e,t,e=>{e&&c(e),s()})};""===n.ext?(0,a.default)(t).then(o=>{u(e.source,t+"/"+r.default.basename(e.source))}):u(e.source,t)}else{u(e.source+("/"!==e.source.substr(-1)?"/":"")+"**/*",e.destination,s,c,t)}})}):u(e.source,e.destination,s,c,t)})};var n=c(o(0)),r=c(o(1)),s=c(o(7)),i=c(o(2)),a=c(o(3));function c(e){return e&&e.__esModule?e:{default:e}}function u(e,t,o,n,r){const{verbose:i}=r;i&&console.log(`  - Lambda Webpack Plugin: Start copy source file: ${e} to destination file: ${t}`),s.default.copy(e,t,{clean:!1,includeEmptyDirs:!0,update:!1},s=>{s&&r.verbose&&(console.log("  - Lambda Webpack Plugin: Error - copy failed",s),n(s)),i&&console.log(`  - Lambda Webpack Plugin: Finished copy source: ${e} to destination: ${t}`),o()})}},function(e,t){e.exports=require("cpx")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.moveAction=function(e,t){const{verbose:o}=t;if(!e.source||!e.destination)return void(o&&console.log("  - Lambda Webpack Plugin: Warning - move parameter has to be formated as follows: { source: <string>, destination: <string> }"));return n.default.existsSync(e.source)?()=>new Promise((t,n)=>{o&&console.log(`  - Lambda Webpack Plugin: Start move source: ${e.source} to destination: ${e.destination}`),(0,r.default)(e.source,e.destination,{mkdirp:!1},r=>{r&&(o&&console.log("  - Lambda Webpack Plugin: Error - move failed",r),n(r)),o&&console.log(`  - Lambda Webpack Plugin: Finished move source: ${e.source} to destination: ${e.destination}`),t()})}):void process.emitWarning(`  - Lambda Webpack Plugin: Could not move ${e.source}: path does not exist`)};var n=s(o(0)),r=s(o(9));function s(e){return e&&e.__esModule?e:{default:e}}},function(e,t){e.exports=require("mv")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkdirAction=function(e,t){const{verbose:o}=t;return()=>{if(o&&console.log(`  - Lambda Webpack Plugin: Creating path ${e.source}`),"string"==typeof e.source)return(0,r.default)(e.source);o&&console.log("  - Lambda Webpack Plugin: Warning - mkdir parameter has to be type of string. Process canceled.")}};var n,r=(n=o(3))&&n.__esModule?n:{default:n}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.archiveAction=function(e,t){const{verbose:o}=t;return()=>new Promise((t,i)=>{e.source&&e.destination||(o&&console.log("  - Lambda Webpack Plugin: Warning - archive parameter has to be formated as follows: { source: <string>, destination: <string> }"),i());const a=null!==/(\*|\{+|\}+)/g.exec(e.source);n.default.lstat(e.source,(o,c)=>{const u=n.default.createWriteStream(e.destination),l=(0,s.default)(e.format,e.options);l.on("error",e=>i(e)),l.pipe(u);const d=r.default.basename(e.destination),p=Object.assign({ignore:d},e.options.globOptions||{});a?l.glob(e.source,p):c.isFile()?l.file(e.source,{name:r.default.basename(e.source)}):c.isDirectory()&&l.glob("**/*",{cwd:e.source,ignore:d}),l.finalize(),t()})})};var n=i(o(2)),r=i(o(1)),s=i(o(12));function i(e){return e&&e.__esModule?e:{default:e}}},function(e,t){e.exports=require("archiver")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAction=function(e,t){const{verbose:o}=t;if(!e.source||!e.content)return void(o&&console.log("  - Lambda Webpack Plugin: Warning - creat parameter has to be formated as follows: { source: <string>, content: <string> }"));return()=>new Promise((t,n)=>{o&&console.log(`  - Lambda Webpack Plugin: Start creating source: ${e.source}`),r.default.writeFile(e.source,e.content,r=>r?(o&&console.log(`  - Lambda Webpack Plugin: Failed to create source: ${e.source}`),n()):(o&&console.log(`  - Lambda Webpack Plugin: Finished to create source: ${e.source}`),t()))})};var n,r=(n=o(0))&&n.__esModule?n:{default:n}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rimrafAction=function(e,t){const{verbose:o}=t;if(!e.source)return void(o&&console.log("  - Lambda Webpack Plugin: Warning - remove parameter has to be formated as follows: { source: <string> }"));return()=>new Promise((t,n)=>{o&&console.log(`  - Lambda Webpack Plugin: Start removing source: ${e.source} `),(0,r.default)(e.source,()=>{o&&console.log(`  - Lambda Webpack Plugin: Finished removing source: ${e.source} `),t()})})};var n,r=(n=o(15))&&n.__esModule?n:{default:n}},function(e,t){e.exports=require("rimraf")}])}));