!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["Lambda Webpack Plugin"]=t():e["Lambda Webpack Plugin"]=t()}(global,(function(){return function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=4)}([function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("fs-extra")},function(e,t){e.exports=require("make-dir")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SamWebpackPlugin=void 0;var r=a(o(0)),n=a(o(1)),s=o(5),i=o(16);function a(e){return e&&e.__esModule?e:{default:e}}function c(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,r)}return o}function u(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?c(Object(o),!0).forEach((function(t){l(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):c(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function l(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}const d="SamWebpackPlugin",p=e=>Object.keys(e).sort().reduce((t,o)=>("object"!=typeof e[o]||Array.isArray(e[o])?t[o]=e[o]:t[o]=p(e[o]),t),{});t.SamWebpackPlugin=class{constructor(e){if(l(this,"declarationRegex",/(?<=@WebpackLambda\()([^\)]+)(?=(\)))/g),l(this,"deploymentFolder",void 0),l(this,"options",{}),l(this,"layers",{}),l(this,"baseTemplate",void 0),l(this,"packageLock",void 0),e.output&&"string"!=typeof e.output)throw`[${d}]: options.output must be of type String`;if(this.deploymentFolder=e.output||"./lambda-sam-deploy",e.verbose&&"boolean"!=typeof e.verbose)throw`[${d}]: options.output must be a boolean`;if(this.options.verbose=e.verbose||!1,e.requireTxt&&"boolean"!=typeof e.requireTxt)throw`[${d}]: options.requireTxt must be a boolean`;if(this.options.requireTxt=e.requireTxt||!1,Boolean(e.layers)&&"object"!=typeof e.layers)throw`[${d}]: options.layers must be of type object`;if(this.layers=e.layers,e.dynamoDb&&"string"!=typeof e.dynamoDb)throw`[${d}]: options.dynamoDb of type String`;if(this.options.dynamoDb=e.dynamoDb,!e.baseTemplate||"string"!=typeof e.baseTemplate)throw`[${d}]: options.baseTemplate must be of defined and of type String`;try{this.baseTemplate=JSON.parse(r.default.readFileSync(e.baseTemplate,"utf8"))}catch(e){throw`[${d}]: Error loading/parsing baseTemplate`}this.packageLock=JSON.parse(r.default.readFileSync("./package-lock.json","utf8"))}parseLambdaDeclaration(e){const t=e.match(this.declarationRegex);if(t)return JSON.parse(t[0])}logDependencies(e){const t=[],o=[],r=e;for(;r&&Array.isArray(r)&&r.length>0;){const s=r[0];if(s.request){const e=s.request===n.default.basename(s.request),r=s.module&&s.module.externalType,i=s.module&&s.module.dependencies;if(i){const e=i.filter(e=>e.request&&!o.includes(e.request)||!e.request);t.push(...e)}e&&t.push({request:s.request,type:r}),o.push(s.request)}e.shift()}return t}recursiveGetDepsRequires(e){return Object.keys(e).reduce((t,o)=>("string"==typeof e[o]&&t.push(o),e[o].requires&&t.push(...this.recursiveGetDepsRequires(e[o].requires)),e[o].dependencies&&t.push(...this.recursiveGetDepsRequires(e[o].dependencies)),t),[])}getPackageDependencies(e,t){try{const t=this.packageLock&&this.packageLock.dependencies&&this.packageLock.dependencies[e];return t&&t.requires?this.recursiveGetDepsRequires(t.requires):[]}catch(e){throw e}}getAllDependencies(e,t){const o=Array.isArray(e)?e:[e];this.options.verbose&&console.log(o);const r=[];for(;o.length>0;){const e=o.shift();try{const n=this.getPackageDependencies(e,t).filter(e=>!r.includes(e));o.push(...n),r.push(e)}catch(e){console.warn(`WARN: Lambda Webpack Plugin: ${e}`)}}return r}apply(e){const t={name:d},o={entries:{},outputPath:e.options.output.path,deployFolder:n.default.join(e.options.context,this.deploymentFolder),alias:e.options.resolve.alias};e.hooks.entryOption.tap(t,(e,t)=>{if("string"==typeof t)throw`[${d}]: webpack entries option must be an object not String.`;o.entries=Object.keys(t).reduce((o,s)=>{try{const i=r.default.readFileSync(t[s],"utf8"),a=this.parseLambdaDeclaration(i);return a?u({},o,{[s]:{key:s,context:e,path:t[s],files:[],filename:n.default.basename(s,n.default.extname(s)),config:a,dependencies:[]}}):o}catch(e){return console.error("error parsing entry content"),o}},{})}),e.hooks.emit.tapAsync(t,(e,t)=>{e.chunks.forEach(e=>{o.entries[e.name]&&(o.entries[e.name].files=e.files,o.entries[e.name].dependencies=this.logDependencies(e.entryModule.dependencies).reduce((e,t)=>(e.find(e=>e.request===t.request)||e.push(t),e),[]))}),t()}),e.hooks.done.tapAsync(t,(e,t)=>{console.log("Creating Lambda Package"),console.time("Create lambda Package Timer");const a=Object.keys(o.entries).map(e=>o.entries[e]),c=[];if(c.push((0,s.rimrafAction)({source:o.deployFolder},this.options)),c.push((0,s.mkdirAction)({source:o.deployFolder},this.options)),a.forEach(e=>{const t=e.filename,r=n.default.join(o.deployFolder,t);if(c.push((0,s.mkdirAction)({source:r},this.options)),e.files.forEach(e=>{c.push((0,s.copyAction)({source:n.default.join(o.outputPath,e),destination:r},this.options))}),c.push((0,s.mkdirAction)({source:n.default.join(r,"node_modules")},this.options)),this.options.requireTxt){const t=e.dependencies.map(e=>e.request).join(" \n");c.push((0,s.createAction)({source:n.default.join(r,"requirements.txt"),content:t},this.options))}if(!this.options.requireTxt){const t=[],o=[...e.dependencies],a=[];for(;o.length>0;){const r=o[0];if(this.layers&&this.layers[r.request])!t.includes(r.request)&&t.push(...this.recursiveGetDepsRequires(r.request)),!a.includes(r.request)&&a.push(r.request);else if(void 0!==r.type&&null!==r.type&&"null"!==r.type&&"undefined"!==r.type){if(r.module&&r.module.buildInfo&&r.module.buildInfo.hasOwnProperty("fileDependencies")){const e=[...r.module.dependencies.filter(e=>e.module&&!a.includes(e.request))];!a.includes(r.request)&&a.push(r.request),o.push(...e)}else{const o=this.getAllDependencies(r.request,n.default.join(e.context,"node_modules"));this.options.verbose&&console.log(r.request,o),t.push(...o),!a.includes(r.request)&&a.push(r.request)}}o.shift()}(0,i.uniqueArray)(t).forEach(t=>{let o=void 0;o=this.layers&&this.layers[t]?n.default.join(this.layers[t],"**/*"):n.default.join(e.context,"node_modules",t,"**/*"),c.push((0,s.copyAction)({source:o,destination:n.default.join(r,"node_modules",t)},this.options))})}const a=p({[`Function${e.filename.replace(/-/g,"")}`]:u({},e.config,{Type:"AWS::Serverless::Function",Properties:u({},e.config.Properties,{},e.config.properties,{CodeUri:`./${t}`})})});this.baseTemplate=u({},this.baseTemplate,{Resources:u({},this.baseTemplate.Resources,{},a)})}),this.options.dynamoDb){const e=JSON.parse(r.default.readFileSync(`${this.options.dynamoDb}`,"utf8"));Object.keys(e).forEach(t=>{this.baseTemplate.Resources[t]={Type:"AWS::DynamoDB::Table",Properties:e[t]}})}if(c.push((0,s.createAction)({source:n.default.join(o.deployFolder,"template.json"),content:JSON.stringify(JSON.parse(JSON.stringify(this.baseTemplate)))},this.options)),c.length){c.reduce((e,t)=>e.then(e=>t(e)).catch(e=>console.log(e)),Promise.resolve()).then(()=>{console.timeEnd("Create lambda Package Timer"),t()}).catch(e=>{console.timeEnd("Create lambda Package Timer"),console.error(e),t()})}else console.timeEnd("Create lambda Package Timer"),t()})}}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"copyAction",{enumerable:!0,get:function(){return r.copyAction}}),Object.defineProperty(t,"moveAction",{enumerable:!0,get:function(){return n.moveAction}}),Object.defineProperty(t,"mkdirAction",{enumerable:!0,get:function(){return s.mkdirAction}}),Object.defineProperty(t,"archiveAction",{enumerable:!0,get:function(){return i.archiveAction}}),Object.defineProperty(t,"createAction",{enumerable:!0,get:function(){return a.createAction}}),Object.defineProperty(t,"rimrafAction",{enumerable:!0,get:function(){return c.rimrafAction}});var r=o(6),n=o(8),s=o(10),i=o(11),a=o(13),c=o(14)},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.copyAction=function(e,t){const{verbose:o}=t;if(!e.source||!e.destination)return void(o&&console.log("  - FileManagerPlugin: Warning - copy parameter has to be formated as follows: { source: <string>, destination: <string> }"));return()=>new Promise((s,c)=>{void 0===/(\*|\{+|\}+)/g.exec(e.source)?r.default.lstat(e.source,(l,d)=>{if(l)return c(l);r.default.lstat(e.destination,(r,l)=>{if(d.isFile()){const t=l&&l.isDirectory()?e.destination+"/"+n.default.basename(e.source):e.destination;o&&console.log(`  - FileManagerPlugin: Start copy source: ${e.source} to destination: ${t}`);const r=n.default.parse(t),u=(e,t)=>{i.default.copy(e,t,e=>{e&&c(e),s()})};""===r.ext?(0,a.default)(t).then(o=>{u(e.source,t+"/"+n.default.basename(e.source))}):u(e.source,t)}else{u(e.source+("/"!==e.source.substr(-1)?"/":"")+"**/*",e.destination,s,c,t)}})}):u(e.source,e.destination,s,c,t)})};var r=c(o(0)),n=c(o(1)),s=c(o(7)),i=c(o(2)),a=c(o(3));function c(e){return e&&e.__esModule?e:{default:e}}function u(e,t,o,r,n){const{verbose:i}=n;i&&console.log(`  - Lambda Webpack Plugin: Start copy source file: ${e} to destination file: ${t}`),s.default.copy(e,t,{clean:!1,includeEmptyDirs:!0,update:!1},s=>{s&&n.verbose&&(console.log("  - Lambda Webpack Plugin: Error - copy failed",s),r(s)),i&&console.log(`  - Lambda Webpack Plugin: Finished copy source: ${e} to destination: ${t}`),o()})}},function(e,t){e.exports=require("cpx")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.moveAction=function(e,t){const{verbose:o}=t;if(!e.source||!e.destination)return void(o&&console.log("  - Lambda Webpack Plugin: Warning - move parameter has to be formated as follows: { source: <string>, destination: <string> }"));return r.default.existsSync(e.source)?()=>new Promise((t,r)=>{o&&console.log(`  - Lambda Webpack Plugin: Start move source: ${e.source} to destination: ${e.destination}`),(0,n.default)(e.source,e.destination,{mkdirp:!1},n=>{n&&(o&&console.log("  - Lambda Webpack Plugin: Error - move failed",n),r(n)),o&&console.log(`  - Lambda Webpack Plugin: Finished move source: ${e.source} to destination: ${e.destination}`),t()})}):void process.emitWarning(`  - Lambda Webpack Plugin: Could not move ${e.source}: path does not exist`)};var r=s(o(0)),n=s(o(9));function s(e){return e&&e.__esModule?e:{default:e}}},function(e,t){e.exports=require("mv")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mkdirAction=function(e,t){const{verbose:o}=t;return()=>{if(o&&console.log(`  - Lambda Webpack Plugin: Creating path ${e.source}`),"string"==typeof e.source)return(0,n.default)(e.source);o&&console.log("  - Lambda Webpack Plugin: Warning - mkdir parameter has to be type of string. Process canceled.")}};var r,n=(r=o(3))&&r.__esModule?r:{default:r}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.archiveAction=function(e,t){const{verbose:o}=t;return()=>new Promise((t,i)=>{e.source&&e.destination||(o&&console.log("  - Lambda Webpack Plugin: Warning - archive parameter has to be formated as follows: { source: <string>, destination: <string> }"),i());const a=null!==/(\*|\{+|\}+)/g.exec(e.source);r.default.lstat(e.source,(o,c)=>{const u=r.default.createWriteStream(e.destination),l=(0,s.default)(e.format,e.options);l.on("error",e=>i(e)),l.pipe(u);const d=n.default.basename(e.destination),p=Object.assign({ignore:d},e.options.globOptions||{});a?l.glob(e.source,p):c.isFile()?l.file(e.source,{name:n.default.basename(e.source)}):c.isDirectory()&&l.glob("**/*",{cwd:e.source,ignore:d}),l.finalize(),t()})})};var r=i(o(2)),n=i(o(1)),s=i(o(12));function i(e){return e&&e.__esModule?e:{default:e}}},function(e,t){e.exports=require("archiver")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createAction=function(e,t){const{verbose:o}=t;if(!e.source||!e.content)return void(o&&console.log("  - Lambda Webpack Plugin: Warning - creat parameter has to be formated as follows: { source: <string>, content: <string> }"));return()=>new Promise((t,r)=>{o&&console.log(`  - Lambda Webpack Plugin: Start creating source: ${e.source}`),n.default.writeFile(e.source,e.content,n=>n?(o&&console.log(`  - Lambda Webpack Plugin: Failed to create source: ${e.source}`),r()):(o&&console.log(`  - Lambda Webpack Plugin: Finished to create source: ${e.source}`),t()))})};var r,n=(r=o(0))&&r.__esModule?r:{default:r}},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.rimrafAction=function(e,t){const{verbose:o}=t;if(!e.source)return void(o&&console.log("  - Lambda Webpack Plugin: Warning - remove parameter has to be formated as follows: { source: <string> }"));return()=>new Promise((t,r)=>{o&&console.log(`  - Lambda Webpack Plugin: Start removing source: ${e.source} `),(0,n.default)(e.source,()=>{o&&console.log(`  - Lambda Webpack Plugin: Finished removing source: ${e.source} `),t()})})};var r,n=(r=o(15))&&r.__esModule?r:{default:r}},function(e,t){e.exports=require("rimraf")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.uniqueArray=void 0;t.uniqueArray=e=>e.filter((e,t,o)=>o.indexOf(e)===t)}])}));